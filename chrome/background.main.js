(()=>{"use strict";let t=!1;const e=async()=>{if(t)return;t=!0,await chrome.contextMenus.removeAll();let e=await s();e?(await chrome.contextMenus.create({id:"MENU_PARENT",title:`${e.user_basic.user_name}的掘金`,contexts:["all"]}),await chrome.contextMenus.create({id:"SELF_HOME",title:"我的主页",parentId:"MENU_PARENT",contexts:["all"]}),await chrome.contextMenus.create({id:"SELF_NOTIFICATION",title:"我的消息",parentId:"MENU_PARENT",contexts:["all"]}),await chrome.contextMenus.create({id:"separator1",type:"separator",parentId:"MENU_PARENT",contexts:["all"]}),await chrome.contextMenus.create({id:"SIGN_IN",title:"快速签到",parentId:"MENU_PARENT",contexts:["all"]}),await chrome.contextMenus.create({id:"BUG_FIX",title:"收集BUG",parentId:"MENU_PARENT",contexts:["all"]}),await chrome.contextMenus.create({id:"FREE_LUCKY_DRAW",title:"免费抽奖",parentId:"MENU_PARENT",contexts:["all"]}),await chrome.contextMenus.create({id:"separator2",type:"separator",parentId:"MENU_PARENT",contexts:["all"]}),await chrome.contextMenus.create({id:"LOGOUT",title:"登出",parentId:"MENU_PARENT",contexts:["all"]})):await chrome.contextMenus.create({id:"OPEN_JUEJIN",type:"normal",title:"掘金首页",contexts:["all"]}),t=!1},a=t=>Object.assign({},t,{success:0===t.err_no}),n=async(t,e)=>{await chrome.storage.local.set({[t]:e})},i=async t=>(await chrome.storage.local.get())[t],c=(t,e)=>{chrome.notifications.getPermissionLevel((a=>{"granted"===a&&chrome.notifications.create((()=>{for(var t=[],e="0123456789abcdef",a=0;a<36;a++)t[a]=e.substr(Math.floor(16*Math.random()),1);return t[14]="4",t[19]=e.substr(3&t[19]|8,1),t[8]=t[13]=t[18]=t[23]="-",t.join("")})(),{type:"basic",title:t,message:e,iconUrl:"static/img/icon.png"})}))},s=async()=>await i("juejin-self"),r=async t=>{await n("juejin-self",t)},o=async()=>{let t=await fetch("https://api.juejin.cn/user_api/v1/user/get_info_pack",{credentials:"include",method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pack_req:{user_counter:!0,user_growth_info:!0,user:!0}})}).then((t=>t.json())),{data:e}=a(t);return e?(await r(e),e):await r(null)},l=async()=>{if(await s()){let t=await fetch("https://api.juejin.cn/interact_api/v1/message/count",{credentials:"include"}).then((t=>t.json())),{success:e,data:s}=a(t);if(e){let{count:t,total:e}=s,a=[];t[1]&&a.push(`点赞和收藏：${t[1]}条`),t[3]&&a.push(`评论：${t[3]}条`);let r=await i("message-not-read");e&&r!==JSON.stringify(a)&&(c(`您有${e}条掘金未读消息，以下为详细内容`,`${a.join("\n")}`),await n("message-not-read",JSON.stringify(a)))}}setTimeout((()=>{l()}),1e4)};chrome.contextMenus.onClicked.addListener((async(t,n)=>{let i=await s(),{windowId:o}=n,{menuItemId:l}=t;"OPEN_JUEJIN"===l&&await chrome.tabs.create({url:"https://juejin.cn/",selected:!0,windowId:o}),"SELF_HOME"===l&&await chrome.tabs.create({url:`https://juejin.cn/user/${i.user_basic.user_id}`,selected:!0,windowId:o}),"SELF_NOTIFICATION"===l&&await chrome.tabs.create({url:"https://juejin.cn/notification",selected:!0,windowId:o}),"LOGOUT"===l&&await(async()=>{await fetch("https://juejin.cn/passport/web/logout/",{credentials:"include"});let t=await(async()=>await chrome.tabs.query({url:"https://juejin.cn/*"}))();for(let e of t)await chrome.tabs.update(e.id,{url:e.url});await r(null),await e()})(),"SIGN_IN"===l&&await(async()=>{let t=await fetch("https://api.juejin.cn/growth_api/v1/check_in",{credentials:"include",method:"POST"}).then((t=>t.json())),{success:e,data:n,err_msg:i}=a(t);c("掘金签到："+(e?"成功":"失败"),e?`本次新增矿石：${n.incr_point}，当前矿石：${n.sum_point}`:i)})(),"BUG_FIX"===l&&await(async()=>{let t=await fetch("https://api.juejin.cn/user_api/v1/bugfix/not_collect",{credentials:"include",method:"POST"}).then((t=>t.json())),{success:e,data:n,err_msg:i}=a(t);c("掘金BugFix："+(e?"成功":"失败"),e?`今日掘金bugfix：${n.length}`:i),e&&n.forEach((t=>{fetch("https://api.juejin.cn/user_api/v1/bugfix/collect",{credentials:"include",method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})}))})(),"FREE_LUCKY_DRAW"===l&&await(async()=>{let t=await fetch("https://api.juejin.cn/growth_api/v1/lottery_config/get",{credentials:"include"}).then((t=>t.json()));return t=a(t),t.success?t.data.free_count?(t=await fetch("https://api.juejin.cn/growth_api/v1/lottery/draw",{credentials:"include",method:"POST"}).then((t=>t.json())),t=a(t),t.success?void c("今日免费抽奖成功",`恭喜抽到：${t.data.lottery_name}`):c("今日免费抽奖失败",t.err_msg)):c("今日免费抽奖失败","今日免费抽奖次数已经用完"):c("今日免费抽奖失败",t.err_msg)})()})),chrome.tabs.onUpdated.addListener((async(t,a,n)=>{if("complete"!==a.status)return;let i=(t=>t.url.includes("juejin.cn"))(n);i&&await o(),await e(),i&&await chrome.tabs.sendMessage(n.id,{from:"background",event:"page-change-complete"})})),(async()=>{await(async()=>{await o(),await l()})(),await(async()=>{await e()})()})()})();
//# sourceMappingURL=background.main.js.map